<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="boot.sagu.mapper.ChatMessageMapper">
    <resultMap id="ChatMessageResultMap" type="boot.sagu.dto.ChatMessageDto">
        <id property="message_id" column="message_id"/>
        <result property="chat_room_id" column="chat_room_id"/>
        <result property="sender_id" column="sender_id"/>
        <result property="message_type" column="message_type"/>
        <result property="message_content" column="message_content"/>
        <result property="created_at" column="created_at"/>
        <result property="is_read" column="is_read"/>
    </resultMap>
    
    <insert id="insertMessage" parameterType="boot.sagu.dto.ChatMessageDto" useGeneratedKeys="true" keyProperty="message_id">
    INSERT INTO chatmessage (
        chat_room_id,
        sender_id,
        message_content,
        message_type,
        created_at
    ) VALUES (
        #{chat_room_id},
        #{sender_id},
        #{message_content},
        #{message_type},
        #{created_at}
    )
</insert>
	
    <select id="getAllMessages" parameterType="long" resultMap="ChatMessageResultMap">
      SELECT
        m.message_id,
        m.chat_room_id,
        m.sender_id,
        m.message_type,
        CASE
            WHEN m.message_type = 'image' THEN f.file_url
            ELSE m.message_content
        END as message_content,
        m.created_at,
        m.is_read
    FROM chatmessage m
    LEFT JOIN chatfile f ON m.message_id = f.message_id
    WHERE m.chat_room_id = #{chat_room_id}
    ORDER BY m.created_at ASC
    </select>
    <update id="updateMessagesAsRead" parameterType="map">
            UPDATE chatmessage 
        SET is_read = 1 
        WHERE chat_room_id = #{chatRoomId} 
        AND sender_id != #{readerId} 
        AND is_read = 0
    </update>
    
</mapper>